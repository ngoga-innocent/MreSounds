{% extends 'base_code.html' %} {% load static %} {% block title %} {% endblock %} 


{% block content %}
<div class="flex flex-col items-center justify-center">
    <div class="grid grid-cols-2">
        <div>

        </div>
        <form id="paymentForm"  class="form-control w-96 ">
            {% csrf_token %}
            <input type="hidden" name="course_id" value="{{course_id}}" id="course_id">
            <div class="">
                <label for="email">Email Address</label><br>
                <input type="email" id="email-address" required  class="w-full rounded-md"/>
            </div>
            <div class="">
                <label for="amount">Amount</label> <br>
                <input type="tel" id="amount" required class="w-full rounded-md" />
            </div>
            <div class="">
                <label for="first-name">First Name</label></br>
                <input type="text" id="first-name" class="w-full rounded-md" />
            </div>
            <div class="">
                <label for="last-name">Last Name</label> </br>
                <input type="text" id="last-name" class="w-full rounded-md" />
            </div>
            <div class="form-submit mt-2 " >
                <button type="submit" class="rounded-lg px-5 py-1 bg-blue-600 text-white font-bold" onclick="payWithPaystack()"> Pay </button>
            </div>
</form>
</div>
    </div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    const paymentForm = document.getElementById('paymentForm');
    const courseId=$('#course_id').val()
    paymentForm.addEventListener("submit", payWithPaystack, false);

    function payWithPaystack(e) {
    e.preventDefault();

    let handler = PaystackPop.setup({
        key: 'pk_test_c270e6ef2f91bbdb8df0d1fc02fc51cab9be46c1', // Replace with your public key
        email: document.getElementById("email-address").value,
        amount: document.getElementById("amount").value * 100,
        currency:'RWF',
        ref: ''+Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
        // label: "Optional string that replaces customer email"
        onClose: function(){
        alert('Window closed.');
        },
        callback: function(response){
            
        let message = 'Payment complete! Reference: ' + response.reference;
        if(response.message=='Approved'){
            $.ajax({
                url:'/payment/' + courseId,
                method:'POST',
                data:{
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                success:function(data){
                    location.reload()
                },
                error:function(error){
                    console.error(error)
                }

            })
        }
        alert(message);
        }
    });

    handler.openIframe();
    }
</script>
{% endblock content %}